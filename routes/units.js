import express from "express";
import db from "../db.js";

const router = express.Router();

/* ======================================================
   ğŸŸ¢ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
====================================================== */
router.get("/", async (_, res) => {
  try {
    const [rows] = await db.query(`
      SELECT id, name
      FROM units
      ORDER BY id DESC
    `);

    res.json({ success: true, units: rows });
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª:", err);
    res.status(500).json({ success: false, message: "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±" });
  }
});

/* ======================================================
   âœ… Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
====================================================== */
router.post("/", async (req, res) => {
  try {
    const { name } = req.body;

    if (!name) {
      return res.status(400).json({
        success: false,
        message: "âŒ Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨",
      });
    }

    await db.query(
      "INSERT INTO units (name) VALUES (?)",
      [name.trim()]
    );

    res.json({ success: true, message: "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­" });
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©:", err);
    res.status(500).json({ success: false, message: "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±" });
  }
});

/* ======================================================
   âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø¯Ø©
====================================================== */
router.put("/:id", async (req, res) => {
  try {
    const { name } = req.body;

    if (!name) {
      return res.status(400).json({
        success: false,
        message: "âŒ Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨",
      });
    }

    const [exists] = await db.query(
      "SELECT id FROM units WHERE id=?",
      [req.params.id]
    );

    if (!exists.length) {
      return res.status(404).json({
        success: false,
        message: "âŒ Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©",
      });
    }

    await db.query(
      "UPDATE units SET name=? WHERE id=?",
      [name.trim(), req.params.id]
    );

    res.json({ success: true, message: "âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©" });
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©:", err);
    res.status(500).json({ success: false, message: "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±" });
  }
});

/* ======================================================
   ğŸ—‘ï¸ Ø­Ø°Ù ÙˆØ­Ø¯Ø©
====================================================== */
router.delete("/:id", async (req, res) => {
  try {
    const [exists] = await db.query(
      "SELECT id FROM units WHERE id=?",
      [req.params.id]
    );

    if (!exists.length) {
      return res.status(404).json({
        success: false,
        message: "âŒ Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©",
      });
    }

    await db.query("DELETE FROM units WHERE id=?", [req.params.id]);

    res.json({ success: true, message: "ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©" });
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©:", err);
    res.status(500).json({ success: false, message: "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±" });
  }
});

export default router;
